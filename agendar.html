<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marcar Horário</title>
    <style>
        :root {
            --gold: #C59A3B; 
            --black: #111111;
            --dark-gray: #1A1A1A;
            --light-gray: #333333;
            --white: #FFFFFF;
            --text-gray: #CCCCCC;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--black); color: var(--white); -webkit-font-smoothing: antialiased; padding: 20px; }
        
        .container { max-width: 500px; margin: 20px auto; background: var(--dark-gray); border-radius: 12px; padding: 30px; border: 1px solid var(--light-gray); }
        .logo { font-weight: 800; font-size: 1.5rem; color: var(--white); letter-spacing: 1px; text-align: center; margin-bottom: 30px; }
        .logo span { color: var(--gold); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-gray); font-size: 0.9rem; font-weight: 500; }
        .form-control { width: 100%; padding: 15px; background: var(--black); border: 1px solid #444; color: var(--white); border-radius: 8px; font-size: 1rem; appearance: none; }
        .form-control:focus { border-color: var(--gold); }

        /* Estilo para o Date Picker (iOS e Android) */
        .form-control[type="date"] { color-scheme: dark; }
        .form-control[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px; transition: opacity 0.2s; }
        .btn-primary { background: var(--gold); color: var(--black); text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary:active { opacity: 0.8; }
        .btn-primary:disabled { background: var(--light-gray); cursor: not-allowed; }
        
        #message { text-align: center; padding: 20px; border-radius: 8px; margin-top: 20px; display: none; font-weight: 500; }
        #message.success { background: #4CAF50; color: white; }
        #message.error { background: #c12929; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <div class="logo">Marcar Horário <span>BarberControl</span></div>
        
        <div id="form-agendamento">
            <div class="form-group">
                <label>Seu Nome</label>
                <input type="text" id="agenda-nome" class="form-control" placeholder="Seu nome completo" required>
            </div>
            <div class="form-group">
                <label>Seu Telefone</label>
                <input type="tel" id="agenda-telefone" class="form-control" placeholder="(99) 99999-9999" required>
            </div>
            <div class="form-group">
                <label>Serviço</label>
                <select class="form-control" id="agenda-servico" required>
                    <option value="" disabled selected>Escolha um serviço...</option>
                    <option value="Corte">Corte de Cabelo</option>
                    <option value="Barba">Barba</option>
                    <option value="Cabelo + Barba">Cabelo + Barba</option>
                    <option value="Sobrancelha">Sobrancelha</option>
                    <option value="Pezinho">Pezinho</option>
                </select>
            </div>
            
            <!-- ==== CAMPO DE HORA "CHEIA" ==== -->
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="agenda-data" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Horário</label>
                <select id="agenda-hora" class="form-control" required>
                    <option value="" disabled selected>Escolha um horário...</option>
                    <option value="08:00">08:00</option>
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                    <option value="18:00">18:00</option>
                </select>
            </div>
            <!-- ==== FIM DA MUDANÇA ==== -->

            <button type="button" class="btn btn-primary" id="btn-submit" onclick="handleAgendamento()">Confirmar Agendamento</button>
        </div>
        
        <div id="message"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            addDoc, 
            setDoc,
            getDocs, // Importar getDocs
            query, 
            where,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ===================================================================
        // <<< CUIDADO! CRIE UM NOVO PROJETO E COLE AS NOVAS CHAVES AQUI! >>>
        // ===================================================================
        
        const firebaseConfig = {
           apiKey: "AIzaSyB8CRcynG97ZLVf24wt9ylbs2kemYk6oSU",
  authDomain: "barbercontrol-6b1f1.firebaseapp.com",
  projectId: "barbercontrol-6b1f1",
  storageBucket: "barbercontrol-6b1f1.firebasestorage.app",
  messagingSenderId: "984412023617",
  appId: "1:984412023617:web:1b10bf21e1ec3a63bf0fc0",
  measurementId: "G-JR9PJSCHWG"
        // ===================================================================
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const messageDiv = document.getElementById('message');
        const submitButton = document.getElementById('btn-submit');
        const form = document.getElementById('form-agendamento'); 

        const urlParams = new URLSearchParams(window.location.search);
        const barbeiroId = urlParams.get('id');

        if (!barbeiroId) {
            showMessage("error", "Link de agendamento inválido. Fale com a barbearia.");
            form.style.display = 'none';
        }

        window.handleAgendamento = async () => {
            if (!barbeiroId) return;

            submitButton.disabled = true;
            submitButton.innerText = "Aguarde...";
            messageDiv.style.display = 'none'; 

            try {
                const nome = document.getElementById('agenda-nome').value;
                const telefone = document.getElementById('agenda-telefone').value;
                const servico = document.getElementById('agenda-servico').value;
                const dataStr = document.getElementById('agenda-data').value;
                const horaStr = document.getElementById('agenda-hora').value;
                
                if (!nome || !telefone || !servico || !dataStr || !horaStr) {
                    throw new Error("Por favor, preencha todos os campos.");
                }

                // Combina a data e a hora no formato ISO (local)
                const dataHoraSelecionada = new Date(`${dataStr}T${horaStr}:00`);
                const agora = new Date();

                if (dataHoraSelecionada < agora) {
                    throw new Error("Você não pode agendar um horário no passado. Por favor, escolha uma data e hora futura.");
                }

                const dataHora = Timestamp.fromDate(dataHoraSelecionada);

                const agendaRef = collection(db, 'empresas', barbeiroId, 'agendamentos');
                
                // ==== CORREÇÃO "AGUARDE INFINITO" (Anti-Conflito) ====
                // 1. Puxa TODOS os agendamentos pendentes (sem índice complexo)
                const qPendente = query(agendaRef, where("status", "==", "pendente"));
                const snapshotPendentes = await getDocs(qPendente);

                // 2. Verifica no JavaScript (100% fiável) se o horário está ocupado
                const horarioOcupado = snapshotPendentes.docs.find(doc => {
                    return doc.data().dataHora.toMillis() === dataHora.toMillis();
                });

                if (horarioOcupado) {
                    throw new Error("Desculpe, este horário exato já foi reservado. Por favor, escolha outro.");
                }
                // ==== FIM DA CORREÇÃO ====


                // 3. Se passou, continua o código normal
                const clienteId = await findOrCreateClient(barbeiroId, nome, telefone);
                
                // 4. Salva (agora com segurança)
                await addDoc(agendaRef, {
                    clienteId: clienteId,
                    clienteNome: nome, 
                    servico: servico,
                    dataHora: dataHora,
                    status: 'pendente'
                });

                showMessage("success", "Horário marcado com sucesso! Até lá.");
                document.getElementById('agenda-nome').value = '';
                document.getElementById('agenda-telefone').value = '';
                document.getElementById('agenda-servico').value = '';
                document.getElementById('agenda-data').value = '';
                document.getElementById('agenda-hora').value = '';

            } catch (error) {
                showMessage("error", error.message || "Erro ao marcar horário. Tente novamente.");
                console.error("Erro: ", error);
            } finally {
                submitButton.disabled = false;
                submitButton.innerText = "Confirmar Agendamento";
            }
        };

        // ==== FUNÇÃO CORRIGIDA (À PROVA DE FALHAS) ====
        // Esta é a função que você pediu, que cadastra o cliente se ele for novo
        async function findOrCreateClient(userId, nome, telefone) {
            const clientesRef = collection(db, 'empresas', userId, 'clientes');
            
            // 1. Puxa TODOS os clientes (sem índice)
            const querySnapshot = await getDocs(clientesRef);
            
            // 2. Filtra no JavaScript (100% fiável)
            const existingClient = querySnapshot.docs.find(doc => doc.data().telefone === telefone);

            if (existingClient) {
                // Cliente já existe, retorna o ID
                return existingClient.id;
            } else {
                // Cliente não existe, cria um novo
                const novoCliente = {
                    nome: nome,
                    telefone: telefone,
                    dataPrimeiraVisita: null 
                };
                const docRef = await addDoc(clientesRef, novoCliente);
                return docRef.id;
            }
        }

        function showMessage(type, text) {
            messageDiv.className = type;
            messageDiv.innerText = text;
            messageDiv.style.display = 'block';
        }

    </script>
</body>
</html>
