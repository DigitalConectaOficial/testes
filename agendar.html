<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marcar Horário</title>
    <style>
        :root {
            --gold: #C59A3B; 
            --black: #111111;
            --dark-gray: #1A1A1A;
            --light-gray: #333333;
            --white: #FFFFFF;
            --text-gray: #CCCCCC;
            --green: #4CAF50;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--black); color: var(--white); -webkit-font-smoothing: antialiased; padding: 20px; }
        
        .container { max-width: 500px; margin: 20px auto; background: var(--dark-gray); border-radius: 12px; padding: 30px; border: 1px solid var(--light-gray); }
        .logo { font-weight: 800; font-size: 1.5rem; color: var(--white); letter-spacing: 1px; text-align: center; margin-bottom: 30px; }
        .logo span { color: var(--gold); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-gray); font-size: 0.9rem; font-weight: 500; }
        .form-control { width: 100%; padding: 15px; background: var(--black); border: 1px solid #444; color: var(--white); border-radius: 8px; font-size: 1rem; appearance: none; }
        .form-control:focus { border-color: var(--gold); }

        .form-control[type="date"] { color-scheme: dark; }
        .form-control[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px; transition: opacity 0.2s; }
        .btn-primary { background: var(--gold); color: var(--black); text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary:active { opacity: 0.8; }
        .btn-primary:disabled { background: var(--light-gray); cursor: not-allowed; }
        .btn-secondary { background: var(--light-gray); color: var(--white); } /* Botão para Copiar PIX */
        
        #message { text-align: center; padding: 20px; border-radius: 8px; margin-top: 20px; display: none; font-weight: 500; }
        #message.success { background: var(--green); color: white; }
        #message.error { background: #c12929; color: white; }

        /* ==== NOVO: Estilo para a Seção PIX ==== */
        #pix-section {
            display: none; /* Começa escondido */
            text-align: center;
            border-top: 1px solid var(--light-gray);
            margin-top: 25px;
            padding-top: 25px;
        }
        #pix-section h4 {
            font-size: 1.1rem;
            color: var(--gold);
            margin-bottom: 15px;
        }
        #pix-section p {
            font-size: 0.9rem;
            color: var(--text-gray);
            line-height: 1.5;
            margin-bottom: 20px;
        }
        #pix-qr-code {
            width: 180px;
            height: 180px;
            border-radius: 8px;
            margin: 10px 0;
            background: white; /* Fundo branco para QR code */
            padding: 5px; /* Espaçamento do QR code */
        }
        /* ==== FIM DO NOVO ESTILO ==== */

    </style>
</head>
<body>

    <div class="container">
        <div class="logo">Marcar Horário <span>BarberControl</span></div>
        
        <div id="form-agendamento">
            <div class="form-group">
                <label>Seu Nome</label>
                <input type="text" id="agenda-nome" class="form-control" placeholder="Seu nome completo" required>
            </div>
            <div class="form-group">
                <label>Seu Telefone</label>
                <input type="tel" id="agenda-telefone" class="form-control" placeholder="(99) 99999-9999" required>
            </div>
            <div class="form-group">
                <label>Serviço</label>
                <select class="form-control" id="agenda-servico" required>
                    <option value="" disabled selected>Escolha um serviço...</option>
                    <option value="Corte">Corte de Cabelo</option>
                    <option value="Barba">Barba</option>
                    <option value="Cabelo + Barba">Cabelo + Barba</option>
                    <option value="Sobrancelha">Sobrancelha</option>
                    <option value="Pezinho">Pezinho</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="agenda-data" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Horário</label>
                <select id="agenda-hora" class="form-control" required>
                    <option value="" disabled selected>Escolha um horário...</option>
                    <option value="08:00">08:00</option>
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                    <option value="18:00">18:00</option>
                </select>
            </div>

            <button type="button" class="btn btn-primary" id="btn-submit" onclick="handleAgendamento()">Confirmar Agendamento</button>
        </div>
        
        <div id="message"></div>

        <!-- ==== NOVA SEÇÃO PIX ==== -->
        <!-- (Input escondido para o Copia e Cola) -->
        <input type="text" id="pix-key-input" value="SUA-CHAVE-PIX-AQUI" style="position:absolute; left: -9999px;">

        <div id="pix-section">
            <h4>Garanta seu horário!</h4>
            <p>Para confirmar 100% a sua vaga, pague um sinal de 50% (ou valor total) via PIX e envie o comprovante para o nosso WhatsApp.</p>
            
            <!-- 
                LEMBRE-SE: Suba a sua imagem de QR Code para o GitHub 
                e nomeie-a "qrcode.png" (ou mude o nome aqui) 
            -->
            <img id="pix-qr-code" src="qrcode.png" alt="QR Code PIX" onerror="this.style.display='none'">
            
            <button type="button" class="btn btn-secondary" onclick="copyPix()">Copiar Chave PIX</button>
        </div>
        <!-- ==== FIM DA SEÇÃO PIX ==== -->

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            addDoc, 
            setDoc,
            getDocs, 
            query, 
            where,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ===================================================================
        // <<< CUIDADO! CRIE UM NOVO PROJETO E COLE AS NOVAS CHAVES AQUI! >>>
        // ===================================================================
        
        const firebaseConfig = {
             apiKey: "AIzaSyB8CRcynG97ZLVf24wt9ylbs2kemYk6oSU",
  authDomain: "barbercontrol-6b1f1.firebaseapp.com",
  projectId: "barbercontrol-6b1f1",
  storageBucket: "barbercontrol-6b1f1.firebasestorage.app",
  messagingSenderId: "984412023617",
  appId: "1:984412023617:web:1b10bf21e1ec3a63bf0fc0",
  measurementId: "G-JR9PJSCHWG"
        };
        // ===================================================================
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const messageDiv = document.getElementById('message');
        const submitButton = document.getElementById('btn-submit');
        const form = document.getElementById('form-agendamento'); 
        const pixSection = document.getElementById('pix-section'); // Puxa a seção PIX

        const urlParams = new URLSearchParams(window.location.search);
        const barbeiroId = urlParams.get('id');

        if (!barbeiroId) {
            showMessage("error", "Link de agendamento inválido. Fale com a barbearia.");
            form.style.display = 'none';
        }

        window.handleAgendamento = async () => {
            if (!barbeiroId) return;

            submitButton.disabled = true;
            submitButton.innerText = "Aguarde...";
            messageDiv.style.display = 'none'; 
            pixSection.style.display = 'none'; // Esconde o PIX ao tentar de novo

            try {
                const nome = document.getElementById('agenda-nome').value;
                const telefone = document.getElementById('agenda-telefone').value;
                const servico = document.getElementById('agenda-servico').value;
                const dataStr = document.getElementById('agenda-data').value;
                const horaStr = document.getElementById('agenda-hora').value;
                
                if (!nome || !telefone || !servico || !dataStr || !horaStr) {
                    throw new Error("Por favor, preencha todos os campos.");
                }

                const dataHoraSelecionada = new Date(`${dataStr}T${horaStr}:00`);
                const agora = new Date();

                if (dataHoraSelecionada < agora) {
                    throw new Error("Você não pode agendar um horário no passado. Por favor, escolha uma data e hora futura.");
                }

                const dataHora = Timestamp.fromDate(dataHoraSelecionada);

                const agendaRef = collection(db, 'empresas', barbeiroId, 'agendamentos');
                
                const qPendente = query(agendaRef, where("status", "==", "pendente"));
                const snapshotPendentes = await getDocs(qPendente);

                const horarioOcupado = snapshotPendentes.docs.find(doc => {
                    return doc.data().dataHora.toMillis() === dataHora.toMillis();
                });

                if (horarioOcupado) {
                    throw new Error("Desculpe, este horário exato já foi reservado. Por favor, escolha outro.");
                }

                const clienteId = await findOrCreateClient(barbeiroId, nome, telefone);
                
                await addDoc(agendaRef, {
                    clienteId: clienteId,
                    clienteNome: nome, 
                    servico: servico,
                    dataHora: dataHora,
                    status: 'pendente'
                });

                showMessage("success", "Horário marcado com sucesso! Veja abaixo como garantir sua vaga:");
                pixSection.style.display = 'block'; // MOSTRA O PIX
                form.reset(); // Limpa o formulário

            } catch (error) {
                showMessage("error", error.message || "Erro ao marcar horário. Tente novamente.");
                console.error("Erro: ", error);
            } finally {
                submitButton.disabled = false;
                submitButton.innerText = "Confirmar Agendamento";
            }
        };

        async function findOrCreateClient(userId, nome, telefone) {
            const clientesRef = collection(db, 'empresas', userId, 'clientes');
            
            const querySnapshot = await getDocs(clientesRef);
            
            const existingClient = querySnapshot.docs.find(doc => doc.data().telefone === telefone);

            if (existingClient) {
                return existingClient.id;
            } else {
                const novoCliente = {
                    nome: nome,
                    telefone: telefone,
                    dataPrimeiraVisita: null 
                };
                const docRef = await addDoc(clientesRef, novoCliente);
                return docRef.id;
            }
        }

        function showMessage(type, text) {
            messageDiv.className = type;
            messageDiv.innerText = text;
            messageDiv.style.display = 'block';
        }

        // ==== NOVA FUNÇÃO: Copiar PIX ====
        window.copyPix = () => {
            const pixInput = document.getElementById('pix-key-input');
            pixInput.select();
            pixInput.setSelectionRange(0, 99999); // Para mobile
            
            try {
                document.execCommand('copy');
                showMessage('success', 'Chave PIX copiada! Agora é só pagar no seu app do banco.');
            } catch (err) {
                showMessage('error', 'Não foi possível copiar. Tente manualmente.');
            }
        }

    </script>
</body>
</html>

